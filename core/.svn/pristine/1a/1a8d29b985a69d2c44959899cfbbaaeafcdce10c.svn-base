<?php

/**
 * Mobile API Controller
 *
 * Responsible as main interface for all mobile traffic.
 *
 * @author <greg.stringer@gmail.com>, <hyunguk@gmail.com>
 */
class MobileController extends Controller {

    public $layout = false;
    private $authenticated = false;
    private $eUser;
    private $outputFormats = array('json', 'xml');
    private $outputFormat = 'json';
    private $responseCode = NULL;
    private $responseCodes = array(
        100 => 'Continue',
        101 => 'Switching Protocols',
        102 => 'Processing',
        200 => 'OK',
        201 => 'Created',
        202 => 'Accepted',
        203 => 'Non-Authoritative Information',
        204 => 'No Content',
        205 => 'Reset Content',
        206 => 'Partial Content',
        207 => 'Multi-Status',
        300 => 'Multiple Choices',
        301 => 'Moved Permanently',
        302 => 'Found',
        303 => 'See Other',
        304 => 'Not Modified',
        305 => 'Use Proxy',
        306 => 'Switch Proxy',
        307 => 'Temporary Redirect',
        400 => 'Bad Request',
        401 => 'Unauthorized',
        402 => 'Payment Required',
        403 => 'Forbidden',
        404 => 'Not Found',
        405 => 'Method Not Allowed',
        406 => 'Not Acceptable',
        407 => 'Proxy Authentication Required',
        408 => 'Request Timeout',
        409 => 'Conflict',
        410 => 'Gone',
        411 => 'Length Required',
        412 => 'Precondition Failed',
        413 => 'Request Entity Too Large',
        414 => 'Request-URI Too Long',
        415 => 'Unsupported Media Type',
        416 => 'Requested Range Not Satisfiable',
        417 => 'Expectation Failed',
        418 => 'I\'m a teapot',
        422 => 'Unprocessable Entity',
        423 => 'Locked',
        424 => 'Failed Dependency',
        425 => 'Unordered Collection',
        426 => 'Upgrade Required',
        449 => 'Retry With',
        450 => 'Blocked by Windows Parental Controls',
        500 => 'Internal Server Error',
        501 => 'Not Implemented',
        502 => 'Bad Gateway',
        503 => 'Service Unavailable',
        504 => 'Gateway Timeout',
        505 => 'HTTP Version Not Supported',
        506 => 'Variant Also Negotiates',
        507 => 'Insufficient Storage',
        509 => 'Bandwidth Limit Exceeded',
        510 => 'Not Extended'
    );

    const cResponseUserAuthenticationInsufficient = 'Insufficient authentication parameters.';
    const cResponseUserAuthenticationFailure = 'Username/Password invalid.';
    const cResponseUserAuthenticationSuccess = 'Login Successful.';
    const cResponseUserDeAuthenticationSuccess = 'Logout Successful.';
    const cResponseUserRegistrationInsufficient = 'Insufficient registration parameters.';
    const cResponseUserOwnershipVerificationFailure = 'Access to resource is restricted to resource owner.';
    const cResponseVideoEncodeFailure = 'Unable to encode video.';

    /**
     * Initialize. Here we set a custom error handler so that we do not 
     * output default html.
     */
    public function init() {
        parent::init();
        Yii::app()->errorHandler->errorAction = 'mobile/error';
    }

    public function filters() {
        return array();
    }

    /**
     * Dummy action so that we can output json/xml errors instead of html.
     */
    public function actionError() {
        $this->throwException(404);
    }

    /**
     * Sets appropriate http(s) headers based on given response code.
     * In PHP 5.4 this is native functionality.
     * @param int $responseCode
     * @return int
     */
    private function setHttpResponse($responseCode = NULL) {
        if ($responseCode !== NULL) {
            $text = $this->responseCodes[$responseCode];
            $protocol = (isset($_SERVER['SERVER_PROTOCOL']) ? $_SERVER['SERVER_PROTOCOL'] : 'HTTP/1.0');
            header($protocol . ' ' . $responseCode . ' ' . $text);
            $this->responseCode = $responseCode;
        } else {
            $responseCode = (isset($this->responseCode) ? $this->responseCode : 200);
        }
        return $responseCode;
    }

    /**
     * throwException()
     * Calls renderOutput (which ends script execution) after setting http 
     * response code and deciding which type of data format to return.
     * @param int $responseCode
     * @param string $responseText 
     */
    private function throwException($responseCode = NULL, $responseText = '') {
        if ($responseText == '') {
            $responseText = $this->responseCodes[$responseCode];
        }
        $this->renderOutput(array('responseCode' => $responseCode, 'responseText' => $responseText), $responseCode);
    }

    /**
     * First sets http response then renders output in either json or xml format.
     * This is where script execution ends. Do not call exit.
     * @param type $output
     * @param type $responseCode 
     */
    private function renderOutput($output = array(), $responseCode = 200) {
        $this->setHttpResponse($responseCode);
        if (count($output) > 0) {
            switch ($this->outputFormat) {
                case 'json':
                    echo $this->renderJson($output);
                    break;
                case 'xml':
                    echo $this->renderXml($output);
                    break;
                default:
                    // Bad request
                    $this->setHttpResponse(400);
                    break;
            }
        }
        // todo - no data returned.. double check
        Yii::app()->end();
    }

    /**
     * Converts a PHP array to XML for output purposes.
     * @param array $output
     * @return XML
     */
    private function renderXml($output = array()) {

        header('Content-type: application/xml');
        $xml = new SimpleXMLElement('<root/>');
        $output = array_flip($output);
        array_walk_recursive($output, array($xml, 'addChild'));
        return $xml->asXML();
    }

    /**
     * Converts a PHP array to json for output purposes.
     * @param array $output
     * @return JSON
     */
    private function renderJson($output = array()) {
        header('Content-type: application/json');
        return CJSON::encode($output);
    }

    /**
     * Takes an array of models and returns the first error found
     * @param type $models
     * @return string:bool 
     */
    private function getErrorFromModels($models = array()) {
        foreach ($models as $model) {
            foreach ($model->attributes as $key => $val) {
                $error = $model->getError($key);
                if (!is_null($error)) {
                    return str_replace('"', '', $error);
                }
            }
        }
        return false;
    }

    /**
     * Removes crutial information from an object
     * @param object $object 
     * @return object $object
     */
    private function cleanseObject($object = null, $properties = array()) {
        if (!is_null($object) && count($properties) > 0) {
            foreach ($properties as $key => $prop) {
                unset($object->{$prop});
            }
        }
        return $object;
    }

    /**
     * Removes crutial information from eUser object
     * @param object $eUser 
     */
    private function cleanseUser($eUser) {
        $properties = array('password',
            'salt',
            'source',
            'role');
        $eUser->created_on = strtotime($eUser->created_on);
        $eUser->updated_on = strtotime($eUser->updated_on);
        $eUser = $this->cleanseObject($eUser, $properties);
        return $eUser;
    }

    /**
     * Removes crutial information from eUserLocation object
     * @param object $eUserLocation 
     * @return object $eUserLocation
     */
    private function cleanseUserLocation($eUserLocation) {
        $properties = array('id',
            'address1',
            'address2',
            'city',
            'state',
            'country',
            'timezone',
            'type');
        $eUserLocation->created_on = strtotime($eUserLocation->created_on);
        $eUserLocation->updated_on = strtotime($eUserLocation->updated_on);
        $eUserLocation = $this->cleanseObject($eUserLocation, $properties);
        return $eUserLocation;
    }

    /**
     * Removes crutial information from eUserEmail object
     * @param object $eUserEmail 
     * @return object $eUserEmail
     */
    private function cleanseUserEmail($eUserEmail) {
        $properties = array('id',
            'type',
            'active');
        $eUserEmail->created_on = strtotime($eUserEmail->created_on);
        $eUserEmail->updated_on = strtotime($eUserEmail->updated_on);
        $eUserEmail = $this->cleanseObject($eUserEmail, $properties);
        return $eUserEmail;
    }
    
    
    /**
     * Authenticates a user
     */
    public function actionLogin() {
        if($this->authenticate() && $_SERVER['REQUEST_METHOD'] == 'GET') {
            $output = array('eUser' => $this->cleanseUser($this->eUser));
            $this->renderOutput($output);
        }
    }
    
    /**
     * Deauthenticates a user
     */
    public function actionLogout() {
        if($this->authenticate() && $_SERVER['REQUEST_METHOD'] == 'GET') {
            // log user out 
            // Unauthorized
            $this->throwException(401, self::cResponseUserDeAuthenticationSuccess);
        }
    }

    /**
     * Call this when ever a user needs to be valid in order to
     * perform a subsequent function.
     * @return bool
     */
    private function authenticate() {

        $eUser = new eUser;
        $eUser->setScenario('login');
        $eUser->username = $_SERVER['PHP_AUTH_USER'];
        $eUser->password = $_SERVER['PHP_AUTH_PW'];
        $eUser->source = 'mobile';

        if (UserUtility::login($eUser, false, true)) {
            // todo - have userUtil return the user object for both mobile and web
            $this->eUser = $eUser->findByAttributes(array('username' => $eUser->username));
            $this->authenticated = true;
            AuditUtility::save($this, $_REQUEST, array(), $this->eUser->id);
            // return successful login data
            //$output = array('user_id' => $this->eUser->id);
            //$this->renderOutput($output);
            return true;
        } else {
            // Unauthorized
            $this->throwException(401, self::cResponseUserAuthenticationFailure);
        }
    }

    /**
     * Verify that a user owns the resource they are attempting to access
     * @param int $id 
     */
    private function verifyOwnership($id) {

        if ($id != $this->eUser->id) {
            // Forbidden
            $this->throwException(403, self::cResponseUserOwnershipVerificationFailure);
        }
    }

    /**
     * Attempts to create a new eUser record.
     * @return type array
     */
    private function userAdd() {
        if (isset($_POST['eUser'], $_POST['eUserEmail'], $_POST['eUserLocation'])) {
            $eUser = new eUser;
            $eUserEmail = new eUserEmail;
            $eUserLocation = new eUserLocation;
            $eUser->setScenario('register');
            $eUserEmail->setScenario('register');
            $eUserLocation->setScenario('register');
            $eUser->attributes = $_POST['eUser'];
            $eUserEmail->attributes = $_POST['eUserEmail'];
            $eUserLocation->attributes = $_POST['eUserLocation'];
            $eUser->username = $eUserEmail->email;
            $eUser->birthday = $eUser->birthYear . '-' . $eUser->birthMonth . '-' . $eUser->birthDay;
            $eUser->source = 'mobile';
            $eUserEmail->type = 'primary';
            $eUserEmail->active = 1;
            $eUserLocation->type = 'primary';

            if (UserUtility::register($eUser, $eUserEmail, $eUserLocation)) {
                MailUtility::send('welcome', $eUserEmail->email);
                //$this->authenticate($eUser->username, $eUser->password);
                // return successful login data
                $eUser = $this->cleanseUser($eUser);
                $eUserLocation = $this->cleanseUserLocation($eUserLocation);
                $eUserEmail = $this->cleanseUserEmail($eUserEmail);

                $output =  array('eUser' => $eUser,
                                'eUserLocation' => $eUserLocation,
                                'eUserEmail' => $eUserEmail);
                return $output;
            }

            $this->throwException(400, $this->getErrorFromModels(array($eUser, $eUserEmail, $eUserLocation)));
        }
    }

    /**
     * Attempts to retrieve a user based on id
     * @param int $id
     * @return object:null 
     */
    private function userGet($id) {
        $eUser = eUser::model()->findByPk($id);
        $eUserLocation = $this->userLocationGet($id);
        $eUserEmail = $this->userEmailGet($id);
        if (!is_null($eUser) && !is_null($eUserLocation) && !is_null($eUserEmail)) {
            $eUser = $this->cleanseUser($eUser);
            $eUserLocation = $this->cleanseUserLocation($eUserLocation);
            $eUserEmail = $this->cleanseUserEmail($eUserEmail);
        }
        
        $output = array('eUser' => $eUser,
                        'eUserLocation' => $eUserLocation,
                        'eUserEmail' => $eUserEmail);
        return $output;
    }

    /**
     * Attempts to retrieve a user location based on id
     * @param int $id
     * @return object:null 
     */
    private function userLocationGet($id) {
        return eUserLocation::model()->findByAttributes(array('user_id' => $id, 'type' => 'primary'));
    }

    /**
     * Attempts to retrieve a user email based on id
     * @param int $id
     * @return object:null 
     */
    private function userEmailGet($id) {
        return eUserEmail::model()->findByAttributes(array('user_id' => $id, 'type' => 'primary'));
    }

    /**
     * Attempts to update a user based on id.
     * @param int $id
     * @return array:null  
     */
    private function userUpdate($id) {
        // todo - add eUserLocation and eUserEmail
        $eUserObjects = $this->userGet($id);
        $eUser = $eUserObjects['eUser'];
        $eUserLocation = $eUserObjects['eUserLocation'];
        $eUserEmail = $eUserObjects['eUserEmail'];
        $eUserModified = false;
        $eUserLocationModified = false;
        $eUserEmailModified = false;

        if (!is_null($eUser) && !is_null($eUserLocation) && !is_null($eUserEmail)) {

            $eUser->setScenario('profile');

            // only allow the following attributes
            if (isset($_POST['eUser']['first_name'])) {
                $eUserModified = true;
                $eUser->first_name = $_POST['eUser']['first_name'];
            }
            if (isset($_POST['eUser']['last_name'])) {
                $eUserModified = true;
                $eUser->last_name = $_POST['eUser']['last_name'];
            }
            if (isset($_POST['eUser']['birthMonth'])) {
                $eUserModified = true;
                $eUser->birthMonth = $_POST['eUser']['birthMonth'];
                $eUser->birthday = $eUser->birthYear . '-' . $eUser->birthMonth . '-' . $eUser->birthDay;
            }
            if (isset($_POST['eUser']['birthDay'])) {
                $eUserModified = true;
                $eUser->birthDay = $_POST['eUser']['birthDay'];
                $eUser->birthday = $eUser->birthYear . '-' . $eUser->birthMonth . '-' . $eUser->birthDay;
            }
            if (isset($_POST['eUser']['birthYear'])) {
                $eUserModified = true;
                $eUser->birthYear = $_POST['eUser']['birthYear'];
                $eUser->birthday = $eUser->birthYear . '-' . $eUser->birthMonth . '-' . $eUser->birthDay;
            }
            if (isset($_POST['eUser']['gender'])) {
                $eUserModified = true;
                $eUser->gender = $_POST['eUser']['gender'];
            }
            if (isset($_POST['eUser']['terms_accepted'])) {
                $eUserModified = true;
                $eUser->terms_accepted = $_POST['eUser']['terms_accepted'];
            }
            if (isset($_POST['eUserLocation']['postal_code'])) {
                $eUserLocation->setScenario('profile');
                $eUserLocationModified = true;
                $eUserLocation->postal_code = $_POST['eUserLocation']['postal_code'];
            }
            if (isset($_POST['eUserEmail']['email'])) {
                $eUserEmail->setScenario('profile');
                $eUserEmailModified = true;
                $eUserModified = true;
                $eUserEmail->email = $_POST['eUserEmail']['email'];
                $eUser->username = $eUserEmail->email;
            }

            // handle email first because if not the user model will be updated even
            // if the email model doesn't pass validation
            if ($eUserEmailModified) {
                if ($eUserEmail->validate()) {
                    $eUserEmail->save();
                    $eUserEmail = $this->cleanseUserEmail($eUserEmail);
                } else {
                    $this->throwException(400, $this->getErrorFromModels(array($eUserEmail)));
                }
            }

            if ($eUserLocationModified) {
                if ($eUserLocation->validate()) {
                    $eUserLocation->save();
                    $eUserLocation = $this->cleanseUserLocation($eUserLocation);
                } else {
                    $this->throwException(400, $this->getErrorFromModels(array($eUserLocation)));
                }
            }

            if ($eUserModified) {
                if ($eUser->validate()) {
                    $eUser->save();
                    $eUser = $this->cleanseUser($eUser);
                } else {
                    $this->throwException(400, $this->getErrorFromModels(array($eUser)));
                }
            }

            $output =  array('eUser' => $eUser,
                            'eUserLocation' => $eUserLocation,
                            'eUserEmail' => $eUserEmail);
            return $output;
        } else {
            return NULL;
        }
    }

    /**
     * Attempts to retrieve videos based on given paramaters
     * @param type $user_id
     * @param type $id
     * @param type $limit
     * @param type $offset
     * @return null
     */
    private function videosGet($user_id = NULL, $id = NULL, $limit = 10, $offset = 0) {

        if (!is_null($id) && is_null($user_id)) {
            $eVideo = eVideo::model()->with('user', 'rating', 'views', 'brightcoves')->accepted()->recent()->hasUser()->nonAdvertisement()->findByPk($id);

            if (!is_null($eVideo)) {
                
                $tags = array();
                $tagVideos = eTagVideo::model()->with('tag')->findAllByAttributes(array('video_id' => $eVideo->id));
                foreach ($tagVideos as $tag) {
                    $tags[] = $tag->tag->title;
                }
                
                $output = array(
                    'id' => $eVideo->id,
                    'title' => $eVideo->title,
                    'description' => $eVideo->description,
                    'tags' => implode(',', $tags),
                    'brightcoveID' => $eVideo->brightcoves[0]->brightcove_id,
                    'playerID' => Yii::app()->params['brightcove']['playerID'],
                    'playerKey' => Yii::app()->params['brightcove']['playerKey'],
                    'fallbackURL' => $this->createAbsoluteUrl('/' . basename(Yii::app()->params['paths']['video']) . '/' . $eVideo->filename . VIDEO_POST_FILE_EXT),
                    'thumbnail' => $this->createAbsoluteUrl('/' . basename(Yii::app()->params['paths']['video']) . '/' . $eVideo->thumbnail . VIDEO_IMAGE_FILE_EXT),
                    'views' => $eVideo->views,
                    'stars' => $eVideo->rating,
                    'created_on' => strtotime($eVideo->created_on),
                    'updated_on' => strtotime($eVideo->updated_on),
                    'eUser' => $this->cleanseUser($eVideo->user)
                );
                return $output;
            } else {
                return NULL;
            }
        } else {
            $criteria = new CDbCriteria();
            $criteria->limit = $limit;
            $criteria->offset = $offset;
            if (!is_null($user_id)) {
                $criteria->compare('user_id', $user_id);
            }
            $eVideos = eVideo::model()->with('user', 'rating', 'views', 'brightcoves')->accepted()->recent()->hasUser()->nonAdvertisement()->findAll($criteria);
        }

        $output = array();
        foreach ($eVideos as $eVideo) {

            $tags = array();
            $tagVideos = eTagVideo::model()->with('tag')->findAllByAttributes(array('video_id' => $eVideo->id));
            foreach ($tagVideos as $tag) {
                $tags[] = $tag->tag->title;
            }

            $output[] = array(
                'id' => $eVideo->id,
                'title' => $eVideo->title,
                'description' => $eVideo->description,
                'duration' => $eVideo->duration,
                'frame_rate' => $eVideo->frame_rate,
                'tags' => implode(',', $tags),
                'brightcoveID' => $eVideo->brightcoves[0]->brightcove_id,
                'playerID' => Yii::app()->params['brightcove']['playerID'],
                'playerKey' => Yii::app()->params['brightcove']['playerKey'],
                'fallbackURL' => $this->createAbsoluteUrl('/' . basename(Yii::app()->params['paths']['video']) . '/' . $eVideo->filename . VIDEO_POST_FILE_EXT),
                'thumbnail' => $this->createAbsoluteUrl('/' . basename(Yii::app()->params['paths']['video']) . '/' . $eVideo->thumbnail . VIDEO_IMAGE_FILE_EXT),
                'views' => $eVideo->views,
                'stars' => $eVideo->rating,
                'created_on' => strtotime($eVideo->created_on),
                'updated_on' => strtotime($eVideo->updated_on),
                'eUser' => $this->cleanseUser($eVideo->user)
            );
        }

        if (count($output) > 0) {
            return $output;
        } else {
            return NULL;
        }
    }

    /**
     * Attempts to upload and process an eVideo
     * based on $_POST and $_FILES (Yii handles $_FILES)
     * @return bool|null
     */
    private function videoUpload() {

        $model = new FormMobileVideoUpload;
        
        if (isset($_POST['eVideo'])) {
            
            $model->attributes = $_POST['eVideo'];       
            $model->video = CUploadedFile::getInstanceByName('eVideo[video]');
 
            if (!$model->validate()) {
                $this->throwException(400, $this->getErrorFromModels(array($model)));
            }

            $encoderResult = VideoUtility::encode('MB', $model->video->extensionName, $model->video);
            if(!$encoderResult) {
                $this->throwException(400, self::cResponseVideoEncodeFailure);
            }
            
            $eVideo = new eVideo();
            $eVideo->user_id = $this->eUser->id;
            $eVideo->question_id = $model->question_id;
            $eVideo->filename = $encoderResult['filename'];
            $eVideo->thumbnail = $encoderResult['filename'];
            $eVideo->processed = 1;
            $eVideo->watermarked = $encoderResult['watermarked'];
            $eVideo->title = $model->title;
            $eVideo->description = $model->description;
            $eVideo->duration = $encoderResult['duration'];
            $eVideo->frame_rate = $encoderResult['fileInfo']['video']['frame_rate'];
            $eVideo->view_key = eVideo::generateViewKey();
            $eVideo->source = 'mobile';
            $eVideo->source_user_id = 'mobile';
            $eVideo->to_twitter = 0;
            $eVideo->to_facebook = 0;
            $eVideo->arbitrator_id = $this->eUser->id;
            $eVideo->status = 'new';

            if (VIDEO_FILTERS_EXTENDED) {
                $eVideo->extendedStatus['new'] = true;
                $eVideo->extendedStatus['new_tv'] = true;
            }

            //check auto accept
            $autoApprove = eAppSetting::model()->findByAttributes(Array('attribute' => 'auto_approve_submitted_videos'));
            if ($autoApprove->value) {
                $eVideo->status = 'accepted';
                if (VIDEO_FILTERS_EXTENDED) {
                    $eVideo->extendedStatus['accepted'] = true;
                    $eVideo->extendedStatus['new_tv'] = true;
                }
            }

            if ($eVideo->save()) {

                $output = array(
                    'id' => $eVideo->id,
                    'question_id' => $eVideo->question_id,
                    'title' => $eVideo->title,
                    'description' => $eVideo->description,
                    'duration' => $eVideo->duration,
                    'frame_rate' => $eVideo->frame_rate,
                    'tags' => implode(',', $tags),
                    'brightcoveID' => $eVideo->brightcoves[0]->brightcove_id,
                    'playerID' => Yii::app()->params['brightcove']['playerID'],
                    'playerKey' => Yii::app()->params['brightcove']['playerKey'],
                    'fallbackURL' => $this->createAbsoluteUrl('/' . basename(Yii::app()->params['paths']['video']) . '/' . $eVideo->filename . VIDEO_POST_FILE_EXT),
                    'thumbnail' => $this->createAbsoluteUrl('/' . basename(Yii::app()->params['paths']['video']) . '/' . $eVideo->thumbnail . VIDEO_IMAGE_FILE_EXT),
                    'views' => $eVideo->views,
                    'stars' => $eVideo->rating,
                    'created_on' => strtotime($eVideo->created_on),
                    'updated_on' => strtotime($eVideo->updated_on),
                    'eUser' => $this->cleanseUser($eVideo->user)
                );
                return $output;
            } else {
                $this->throwException(400, $this->getErrorFromModels(array($eVideo)));
            }
        } else {
            return NULL;
        }
    }
    
    /**
     * Attempts to retrieve eImages based on given paramaters
     * @param type $user_id
     * @param type $id
     * @param type $limit
     * @param type $offset
     * @return Array|null
     */
    private function imagesGet($user_id = NULL, $id = NULL, $limit = 10, $offset = 0) {

        if (!is_null($id) && is_null($user_id)) { 
            $eImage = eImage::model()->with('user', 'rating', 'views')->accepted()->recent()->findByPk($id);
            if (!is_null($eImage)) {
                
                $tags = array();
                $tagImages = eTagImage::model()->with('tag')->findAllByAttributes(array('image_id' => $eImage->id));
                foreach ($tagImages as $tag) {
                    $tags[] = $tag->tag->title;
                }
                
                $output = array(
                    'id' => $eImage->id,
                    'user_id' => $eImage->user_id,
                    'title' => $eImage->title,
                    'description' => $eImage->description,
                    'tags' => implode(',', $tags),
                    'view_key' => $eImage->view_key,
                    'is_avatar' => $eImage->is_avatar,
                    'url' => $this->createAbsoluteUrl('/' . basename(Yii::app()->params['paths']['image']) . '/' . $eImage->filename),
                    'views' => $eImage->views,
                    'stars' => $eImage->rating,
                    'created_on' => strtotime($eImage->created_on),
                    'updated_on' => strtotime($eImage->updated_on),
                    'eUser' => $this->cleanseUser($eImage->user)
                );
                return $output;
            } else {
                return NULL;
            }
        } else {
            $criteria = new CDbCriteria();
            $criteria->limit = $limit;
            $criteria->offset = $offset;
            if (!is_null($user_id)) {
                $criteria->compare('user_id', $user_id);
            }
            $eImages = eImage::model()->with('user', 'rating', 'views')->accepted()->recent()->findAll($criteria);
        }

        $output = array();
        foreach ($eImages as $eImage) {

            $tags = array();
            $tagImages = eTagImage::model()->with('tag')->findAllByAttributes(array('image_id' => $eImage->id));
            foreach ($tagImages as $tag) {
                $tags[] = $tag->tag->title;
            }

            $output[] = array(
                'id' => $eImage->id,
                'user_id' => $eImage->user_id,
                'title' => $eImage->title,
                'description' => $eImage->description,
                'tags' => implode(',', $tags),
                'view_key' => $eImage->view_key,
                'is_avatar' => $eImage->is_avatar,
                'url' => $this->createAbsoluteUrl('/' . basename(Yii::app()->params['paths']['image']) . '/' . $eImage->filename),
                'views' => $eImage->views,
                'stars' => $eImage->rating,
                'created_on' => strtotime($eImage->created_on),
                'updated_on' => strtotime($eImage->updated_on),
                'eUser' => $this->cleanseUser($eImage->user)
            );
        }

        if (count($output) > 0) {
            return $output;
        } else {
            return NULL;
        }
    }
    
    /**
     * Attempts to upload and process an eImage
     * based on $_POST and $_FILES (Yii handles $_FILES)
     * @return bool|null
     */
    private function imageUpload() {

        $model = new FormMobileImageUpload;
        
        if (isset($_POST['eImage'])) {
            
            $model->attributes = $_POST['eImage'];       
            $model->image = CUploadedFile::getInstanceByName('eImage[image]');
 
            if (!$model->validate()) {
                $this->throwException(400, $this->getErrorFromModels(array($model)));
            }
            
            $eImage = new eImage();
            $eImage->user_id = $this->eUser->id;
            $eImage->title = $model->title;
            $eImage->description = $model->description;
            $eImage->source = 'mobile';
            $eImage->arbitrator_id = $this->eUser->id;
            $eImage->is_avatar = 0;
            $eImage->watermarked = 0;

            if ($eImage->to_twitter == '1') {
                if (eUserTwitter::model()->countByAttributes(array('user_id' => $this->eUser->id)) == 0) {//no connection to twitter
                    $eImage->to_twitter = 0;
                }
            }
            if ($eImage->to_facebook == '1') {
                if (eUserFacebook::model()->countByAttributes(array('user_id' => $this->eUser->id)) == 0) {//no connection to facebook
                    $eImage->to_facebook = 0;
                }
            }
            if(IMAGE_AUTO_APPROVE) {
                $eImage->status = 'accepted';
                if(IMAGE_FILTERS_EXTENDED){
                    $eImage->extendedStatus['accepted'] = true;
                    $eImage->extendedStatus['new_tv'] = true;
                }
            } else {
                $eImage->status = 'new';
            }
            
            $eImage->filename = $this->eUser->id . "_" . md5(uniqid('',true) . $model->image) . '.' . strtolower($model->image->extensionName);
            $model->image->saveAs(Yii::app()->params['paths']['image'] . "/" . $eImage->filename);
            
            if ($eImage->save()) {

                $output = array(
                    'id' => $eImage->id,
                    'user_id' => $eImage->user_id,
                    'title' => $eImage->title,
                    'description' => $eImage->description,
                    //'tags' => implode(',', $tags),
                    'view_key' => $eImage->view_key,
                    'is_avatar' => $eImage->is_avatar,
                    'url' => $this->createAbsoluteUrl('/' . basename(Yii::app()->params['paths']['image']) . '/' . $eImage->filename),
                    'views' => $eImage->views,
                    'stars' => $eImage->rating,
                    'created_on' => strtotime($eImage->created_on),
                    'updated_on' => strtotime($eImage->updated_on),
                    'eUser' => $this->cleanseUser($eImage->user)
                        );
                return $output;
            } else {
                $this->throwException(400, $this->getErrorFromModels(array($eImage)));
            }
        } else {
            return NULL;
        }
    }
    
    /**
     * Retrieve questions for videos and tickers.
     * @param type $limit
     * @param type $offset
     * @param type $type (video/ticker)
     * @return Array|null
     */
    public function videoTickerQuestionsGet($limit = 10, $offset = 0, $type = 'video') {
        $criteria = new CDbCriteria();
        $criteria->limit = $limit;
        $criteria->offset = $offset;
        $eQuestionObjects = eQuestion::model()->{$type}()->current()->orderByIDDesc()->findAll($criteria);
        if (!is_null($eQuestionObjects)) {
            $output = array();
            foreach ($eQuestionObjects as $eQuestionObject) {
              if($type == 'ticker') {
                  $tally = $eQuestionObject->tickerTally();
              } else {
                  $tally = $eQuestionObject->videoTally();
              }
              $output[] = array(
                  'id' => $eQuestionObject->id,
                  'question' => $eQuestionObject->question,
                  'hashtag' => $eQuestionObject->hashtag,
                  'tally' => $tally,
                  'created_at' => strtotime($eQuestionObject->created_on),
              );
            }
          return $output;
        }
        return NULL;
    }

    /**
     * ********************************************************
     * Begin actions
     * ******************************************************** 
     */

    /**
     * Handles ticker functionality. Expects GET or POST.
     * @param type $user_id
     * @param type $id
     * @param type $limit
     * @param type $offset
     */
    public function actionTickers($limit = 10, $offset = 0) {

        if (!is_numeric($limit)) {
            $this->throwException(400, 'Limit must be numeric.');
        }

        if (!is_numeric($offset)) {
            $this->throwException(400, 'Offset must be numeric.');
        }

        $this->authenticate();

        switch ($_SERVER['REQUEST_METHOD']) {
            
            case 'GET':
                // retrieve eQuestions for ticker
                $eQuestionObjects = $this->videoTickerQuestionsGet($limit, $offset, 'ticker');
                if (!is_null($eQuestionObjects)) {
                    $output = array('eQuestions' => $eQuestionObjects);
                    $this->renderOutput($output);
                }
                $this->throwException(400);
                break;

            // uploading an eVideo
            case 'POST':

                $eVideoObject = $this->videoUpload();
                if (!is_null($eVideoObject)) {
                    $output = array('eVideo' => $eVideoObject);
                    $this->renderOutput($output);
                }
                $this->throwException(400);
                break;

            // we do not allow deletion of videos
            case 'DELETE':
                $this->throwException(403);
                break;

            default:
                $this->throwException(400);
                break;
        }

        $this->throwException(400);
    }

    
    /**
     * Adds, retrieves or updates an eVideo record. Expects GET or POST.
     * @param type $user_id
     * @param type $id
     * @param type $limit
     * @param type $offset
     */
    public function actionVideos($user_id = NULL, $id = NULL, $limit = 10, $offset = 0) {

        if (!is_null($user_id) && !is_numeric($user_id)) {
            $this->throwException(400, 'User ID must be numeric.');
        }

        if (!is_null($id) && !is_numeric($id)) {
            $this->throwException(400, 'ID must be numeric.');
        }

        if (!is_numeric($limit)) {
            $this->throwException(400, 'Limit must be numeric.');
        }

        if (!is_numeric($offset)) {
            $this->throwException(400, 'Offset must be numeric.');
        }

        $this->authenticate();

        switch ($_SERVER['REQUEST_METHOD']) {
            // retrieve eVideos
            case 'GET':

                // get all of a users eVideos
                if (!is_null($user_id)) {
                    $eVideoObjects = $this->videosGet($user_id, NULL, $limit, $offset);
                } elseif (!is_null($id)) {
                    // get eVideo by id
                    $eVideoObjects = $this->videosGet(NULL, $id, NULL, NULL);
                } else {
                    // get all eVideos regardless of user
                    $eVideoObjects = $this->videosGet(NULL, NULL, $limit, $offset);
                }

                if (!is_null($eVideoObjects)) {
                    $output = array('eVideos' => $eVideoObjects);
                    $this->renderOutput($output);
                }
                $this->throwException(400);
                break;

            // uploading an eVideo
            case 'POST':

                $eVideoObject = $this->videoUpload();
                if (!is_null($eVideoObject)) {
                    $output = array('eVideo' => $eVideoObject);
                    $this->renderOutput($output);
                }
                $this->throwException(400);
                break;

            // we do not allow deletion of videos
            case 'DELETE':
                $this->throwException(403);
                break;

            default:
                $this->throwException(400);
                break;
        }

        $this->throwException(400);
    }

    /**
     * Adds, retrieves or updates eUser, eUserEmail and eUserLocation objects. 
     * Expects GET or POST. If user id is null, and method is post, performs insert.
     * If user id not null, and method is post, performs update.
     * @param type $user_id
     */
    public function actionUsers($user_id = null) {

        if (!is_null($user_id)) {
            $this->authenticate();
            $this->verifyOwnership($user_id);
        }

        switch ($_SERVER['REQUEST_METHOD']) {
            // retrieve eUser, eUserEmail and eUserLocation objects
            case 'GET':
                $eUserObjects = $this->userGet($user_id);
                $eUser = $eUserObjects['eUser'];
                $eUserLocation = $eUserObjects['eUserLocation'];
                $eUserEmail = $eUserObjects['eUserEmail'];
                if (!is_null($eUser) && !is_null($eUserLocation) && !is_null($eUserEmail)) {

                    $output = array('eUser' => $eUser,
                        'eUserLocation' => $eUserLocation,
                        'eUserEmail' => $eUserEmail);
                    ;
                    $this->renderOutput($output);
                }
                $this->throwException(400);
                break;

            // add/update eUser, eUserEmail and eUserLocation objects
            // todo - add update password
            case 'POST':
                if ($this->authenticated) {
                    // update eUser, eUserEmail and eUserLocation objects
                    $eUserObjects = $this->userUpdate($user_id);
                    if (!is_null($eUserObjects)) {
                        $output = $eUserObjects;
                        $this->renderOutput($output);
                    }
                    $this->throwException(400);
                } else {
                    // add eUser, eUserEmail and eUserLocation objects

                    $eUserObjects = $this->userAdd();
                    if (!is_null($eUserObjects)) {
                        $output = $eUserObjects;
                        $this->renderOutput($output);
                    }

                    $this->throwException(400, self::cResponseUserRegistrationInsufficient);
                }
                break;

            // we do not allow deletion of users
            case 'DELETE':
                $this->throwException(403);
                break;

            default:
                $this->throwException(400);
                break;
        }

        $this->throwException(400);
    }
    
    
    /**
     * Adds, retrieves or updates an eImage record. Expects GET or POST.
     * @param type $user_id
     * @param type $id
     * @param type $limit
     * @param type $offset
     */
    public function actionImages($user_id = NULL, $id = NULL, $limit = 10, $offset = 0) {

        if (!is_null($user_id) && !is_numeric($user_id)) {
            $this->throwException(400, 'User ID must be numeric.');
        }

        if (!is_null($id) && !is_numeric($id)) {
            $this->throwException(400, 'ID must be numeric.');
        }

        if (!is_numeric($limit)) {
            $this->throwException(400, 'Limit must be numeric.');
        }

        if (!is_numeric($offset)) {
            $this->throwException(400, 'Offset must be numeric.');
        }

        $this->authenticate();

        switch ($_SERVER['REQUEST_METHOD']) {
            // retrieve eVideos
            case 'GET':

                // get all of a users eImages
                if (!is_null($user_id)) {
                    $eImageObjects = $this->imagesGet($user_id, NULL, $limit, $offset);
                } elseif (!is_null($id)) {
                    // get eImage by id
                    $eImageObjects = $this->imagesGet(NULL, $id, NULL, NULL);
                } else {
                    // get all eImages regardless of user
                    $eImageObjects = $this->imagesGet(NULL, NULL, $limit, $offset);
                }

                if (!is_null($eImageObjects)) {
                    $output = array('eImages' => $eImageObjects);
                    $this->renderOutput($output);
                }
                $this->throwException(400);
                break;

            // uploading an eImage
            case 'POST':

                $eImageObject = $this->imageUpload();
                if (!is_null($eImageObject)) {
                    $output = array('eImage' => $eImageObject);
                    $this->renderOutput($output);
                }
                $this->throwException(400);
                break;

            // we do not allow deletion of videos
            case 'DELETE':
                $this->throwException(403);
                break;

            default:
                $this->throwException(400);
                break;
        }

        $this->throwException(400);
    }
    
    /**
     * Retrieves questions for tickers and videos. Expects GET.
     * @param type $type
     * @param type $limit
     * @param type $offset
     */
    public function actionQuestions($type = NULL, $limit = 10, $offset = 0) {
        
        if (is_null($type) || !in_array($type, array('ticker','video'))) {
            $this->throwException(400, 'Unrecognized question type.');
        }
        
        if (!is_numeric($limit)) {
            $this->throwException(400, 'Limit must be numeric.');
        }

        if (!is_numeric($offset)) {
            $this->throwException(400, 'Offset must be numeric.');
        }

        $this->authenticate();

        switch ($_SERVER['REQUEST_METHOD']) {
            // retrieve eQuestions
            case 'GET':
                $eQuestionObjects = $this->videoTickerQuestionsGet($limit, $offset, $type);
                if (!is_null($eQuestionObjects)) {
                    $output = array('eQuestions' => $eQuestionObjects);
                    $this->renderOutput($output);
                }
                $this->throwException(400);
                break;

            default:
                $this->throwException(400);
                break;
        }

        $this->throwException(400);
    }

    
    
    /*

      public function actionVideoQuestions($limit = 3) {
      $userTokenObject = $this->validateToken($_POST['user_token']);
      if (!$userTokenObject) {
      $this->throwException(401, $this->getStatusCodeMessage(401));
      }
      $criteria = new CDbCriteria();
      $criteria->limit = $limit;
      $questions = eQuestion::model()->video()->current()->findAll($criteria);
      $response = array('user_token' => $userTokenObject->token);
      foreach ($questions as $question) {
      $response[$question->id] = array(
      'createDate' => strtotime($question->created_on),
      'question' => $question->question,
      'hashtag' => $question->hashtag,
      );
      }
      $this->renderOutput($response);
      }

      public function actionPoll() {
      $userTokenObject = $this->validateToken($_POST['user_token']);
      if (!$userTokenObject) {
      $this->throwException(401, $this->getStatusCodeMessage(401));
      }
      $criteria = new CDbCriteria();
      $criteria->limit = 1;
      $poll = ePoll::model()->with('pollAnswers')->current()->questionType()->findAll($criteria);
      $response = array(
      'user_token' => $userTokenObject->token,
      'poll_id' => $poll->id,
      'question' => $poll->question,
      'startDate' => strtotime($poll->start_time),
      'endDate' => strtotime($poll->end_time),
      'createDate' => strtotime($poll->created_on)
      );
      foreach ($poll->pollAnswers as $answer) {
      $response[$answer->id] = array(
      'answer' => $answer->answer,
      'color' => $answer->color,
      'point' => $answer->point_value,
      'hashtag' => $answer->hashtag,
      );
      }
      $this->renderOutput($response);
      }

      public function actionVote() {
      $userTokenObject = $this->validateToken($_POST['user_token']);
      if (!$userTokenObject) {
      $this->throwException(401, $this->getStatusCodeMessage(401));
      }
      if (!isset($_POST['ePollResponse'])) {
      $this->throwException(400, $this->getStatusCodeMessage(400));
      }
      $pollResponse = new ePollResponse();
      $pollResponse->attributes = $_POST['ePollResponse'];
      if (!(is_int($pollResponse->poll_id) && is_int($pollResponse->answer_id))) {
      $this->throwException(400, $this->getStatusCodeMessage(400));
      }
      $pollResponse->user_id = $userTokenObject->user->id;
      $pollResponse->source = 'mobile';
      if (!$pollResponse->save()) {
      $this->throwException(400, $this->getStatusCodeMessage(400));
      }
      $response = array('user_token' => $userTokenObject->token);
      $this->renderOutput($response);
      }
     * 
     */
    
    
    
    
    
    
    /*
     * >
> forgotPassword[POST]
> authorizeWithFacebook
> authorizeWithTwitter
> getStaticContent[GET]
> getAppConfig[GET]
> getAd[GET]
> getShows[GET]
> getShowQuestions[GET]
> getVoteData[GET]
> vote[POST]
     */
}
