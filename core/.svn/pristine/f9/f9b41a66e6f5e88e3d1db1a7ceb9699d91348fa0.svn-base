<?php

class VideoUtility {

    public static function concatenatePlaylist($playlist,$prefix){
        if(is_array($playlist)){
            $outfile = uniqid($prefix);
            foreach($playlist as $k=>$v){
                $concat .= "{$v}.ts|";
                $ffmpeg[] = VIDEO_FFMPEG_PATH . " -y -i {$v}" . VIDEO_POST_FILE_EXT . " -c copy -bsf:v h264_mp4toannexb -f mpegts {$v}.ts";
            }
            $concat = rtrim($concat,'|');
            $ffmpeg[] = VIDEO_FFMPEG_PATH . " -y -f mpegts -i \"concat:{$concat}\" ". VIDEO_PARAMS ." -bsf:a aac_adtstoasc " . Yii::app()->params['paths']['video'] . "/{$outfile}" . VIDEO_POST_FILE_EXT;                            
            foreach($ffmpeg as $cmd){
                exec($cmd);
            }
            VideoUtility::ffmpegGenerateThumbFromVideo(Yii::app()->params['paths']['video'].'/'.$outfile.VIDEO_POST_FILE_EXT, Yii::app()->params['paths']['video'].'/'.$outfile.VIDEO_IMAGE_FILE_EXT);
            VideoUtility::ffmpegMp4ToGif(Yii::app()->params['paths']['video'].'/'.$outfile.VIDEO_POST_FILE_EXT, Yii::app()->params['paths']['video'].'/'.$outfile.'.gif');        
            return $outfile;
        } else {
            return false;
        }
    }
    
    public static function curlVideoToFlipFactory($filePath, $fileName) {

        $time = time();
        $newFileName = $time . "-" . $fileName;

        $ftp_server = VIDEO_FLIP_FACTORY_HOST;
        $ftp_user_name = VIDEO_FLIP_FACTORY_USER;
        $ftp_user_pass = VIDEO_FLIP_FACTORY_PASS;

        $ch = curl_init();
        $fp = @fopen($filePath, 'r');
        curl_setopt($ch, CURLOPT_URL, "ftp://$ftp_user_name:$ftp_user_pass@$ftp_server/" . $newFileName);
        curl_setopt($ch, CURLOPT_UPLOAD, 1);
        curl_setopt($ch, CURLOPT_INFILE, $fp);
        curl_setopt($ch, CURLOPT_INFILESIZE, filesize($filePath));
        curl_exec($ch);
        $error = curl_errno($ch);
        curl_close($ch);

        if ($error) {
            return false;
        }

        unlink($filePath);
        return true;
    }

    /*
     * All FFMPEG CALLS
     */
    
    public static function ffmpegFinalizeVideoForTv($fileInput, $fileOutput) {
        if(file_exists($fileInput)) {
            $params = VIDEO_TO_TV_FFMPEG_PARAMS;
            $params = str_replace('{FILE_INPUT}', $fileInput, $params);
            $params = str_replace('{FILE_OUTPUT}', $fileOutput, $params);
            $cmd = VIDEO_FFMPEG_PATH . $params;
            exec($cmd);
            return true;
        }
        
        return false;
    }

    public static function ffmpegMp4ToMov($fileInput, $fileOutput) {

        if (file_exists($fileInput)) {

            $cmd = VIDEO_FFMPEG_PATH . " -y -i $fileInput -acodec copy -vcodec copy -f mov $fileOutput";
            exec($cmd);
            return true;
        }
        return false;
    }

    public static function ffmpegMp4ToGif($fileInput, $fileOutput, $scale = '179:101', $fps = "2") {
        self::ffmpegFlvToGif($fileInput, $fileOutput, $scale, $fps);
    }

    public static function ffmpegFlvToGif($fileInput, $fileOutput, $scale = '179:101', $fps = "2") {
        $fileInfo = VideoUtility::getID3Info($fileInput);
        $duration = round($fileInfo['playtime_seconds']);
        $cmd = VIDEO_FFMPEG_PATH . " -y -i $fileInput -vf scale=$scale,fps=fps=$fps -t 15 $fileOutput";
        exec($cmd);
    }

    public static function getWatermarkFilters($watermark){
        if (file_exists($watermark)) {
            switch (VIDEO_WATERMARK_LOCATION) {
                case 'topLeft':
                    $location = '10:10';
                    break;
                case 'topRight':
                    $location = 'main_w-overlay_w-10:10';
                    break;
                case 'bottomLeft':
                    $location = '10:main_h-overlay_h-10';
                    break;
                case 'bottomRight':
                    $location = 'main_w-overlay_w-10:main_h-overlay_h-10';
                    break;
                case 'center':
                    $location = 'main_w/2-overlay_w/2:main_h/2-overlay_h/2';
                    break;
            }
            return "-vf 'movie={$watermark} [watermark]; [in][watermark] overlay={$location}:1 [out]'";
        } else {
            return '';
        }        
    }
    
    public static function ffmpegFlvToMp4($fileInput, $fileOutput, $duration, $watermark = '') {

        if (file_exists($fileInput)) {
            $watermark = VideoUtility::getWatermarkFilters($watermark);
            $cmd = VIDEO_FFMPEG_PATH . " -y -i $fileInput $watermark -q:v 1 -async 1  -r 30 -b:v 2M -bt 4M -vcodec libx264 -preset placebo -g 1 -movflags +faststart -acodec libfdk_aac -ac 2 -ar 48000 -ab 192k -t $duration $fileOutput";
            exec($cmd);
            return true;
        }

        return false;
    }
    
    public static function ffmpegFlvToOgg($fileInput, $fileOutput, $duration, $watermark = '') {

        if (file_exists($fileInput)) {
            $watermark = VideoUtility::getWatermarkFilters($watermark);            
            $cmd = VIDEO_FFMPEG_PATH . " -y -i $fileInput $watermark -async 1 -r 30 -vcodec libtheora -q:v 7 -acodec libvorbis -q:a 5 -t $duration $fileOutput";
            exec($cmd);
            return true;
        }

        return false;
    }
    

    public static function ffmpegRescaleVideo($fileInput, $fileOutput, $qualityScale = 0, $vf = 'scale=960:540', $fps = 30) {

        if (file_exists($fileInput)) {

            //$cmd = VIDEO_FFMPEG_PATH . " -i $fileInput -qscale $qualityScale -vf $vf -r $fps -g 1 -y  $fileOutput > /dev/null 2>/dev/null & ";
            $cmd = VIDEO_FFMPEG_PATH . " -i $fileInput -qscale $qualityScale -vf $vf -r $fps -g 1 -y  $fileOutput";
            exec($cmd);
            copy($fileOutput, $fileInput);
            unlink($fileOutput);

            return true;
        }

        return false;
    }

    public static function ffmpegGenerateThumbFromVideo($fileInput, $fileOutput, $seekStart = '00:00:00', $format = 'image2', $size = '640x360', $numFrames = 1, $overwrite = '-y') {

        if (file_exists($fileInput)) {

            //$cmd = VIDEO_FFMPEG_PATH . " -ss $seekStart $overwrite -i $fileInput -f $format -s $size -vframes $numFrames $fileOutput > /dev/null 2>/dev/null & ";
            $cmd = VIDEO_FFMPEG_PATH . " -ss $seekStart $overwrite -i $fileInput -f $format -s $size -vframes $numFrames $fileOutput";
            exec($cmd);

            if (file_exists($fileOutput)) {
                return true;
            }
        }
        return false;
    }

    public static function ffprobeVideo($fileInput) {

        if (file_exists($fileInput)) {

            $cmd = VIDEO_FFPROBE_PATH . " -loglevel error -show_format -show_streams -show_format -print_format json $fileInput";
            exec($cmd, $output);

            if (count($output) > 0) {

                $str = '';

                foreach ($output as $o) {
                    $str .= $o;
                }

                return json_decode($str);
            }

            return false;
        }

        return false;
    }

    public static function generateThumbnailsForVideo($fileInput) {

        $videoPath = Yii::app()->params['paths']['video'];
        $videoFilePath = $videoPath . '/' . $fileInput . VIDEO_POST_FILE_EXT;
        $jsonPath = $videoPath . '/' . $fileInput . '.json';

        // check for .json file
        if (file_exists($jsonPath)) {

            //get the thumbs
            return json_decode(file_get_contents($jsonPath));
        } else {

            // generate thumbs & .json file containing thumb filenames
            $durationArray = self::getVideoDuration($videoFilePath);

            // make sure we retrieved the video duration
            if ($durationArray != false) {

                $iterations = 10;
                $duration = explode('.', $durationArray[2]);
                $duration = round($duration[0]);

                if ($duration < $iterations) {
                    $iterations = $duration;
                }

                $return = array();
                // store original thumb
                $return[0] = $fileInput . VIDEO_IMAGE_FILE_EXT;

                // generate 9 thumbnails since one already exist
                for ($i = 1; $i < $iterations; ++$i) {
                    $imageName = $fileInput . '_' . $i . VIDEO_IMAGE_FILE_EXT;
                    $imagePath = $videoPath . '/' . $imageName;
                    $exec = VIDEO_FFMPEG_PATH . " -ss $i -i $videoFilePath -f image2 -vframes 1 $imagePath";
                    exec($exec);
                    $return[$i] = $imageName;
                }

                /*
                 * $count = count($durationArray);
                  $last = ($count - 1);
                  $time = floor($durationArray[$last]);
                  $frames = (VIDEO_FRAMES_PER_SEC * $time);
                  $top = floor($frames);
                 * 
                 * 
                  //only run per offset, groups of 8
                  for ($i = 0; $i < $top; $i++) {
                  if ($i % 3 === 0) {

                  $frame = round(($i / VIDEO_FRAMES_PER_SEC), 2);
                  $second = floor($frame);

                  //print $second;
                  if ($second == $offset) {

                  $imageName = $filename . '_' . $num . '.png';
                  $imagePath = $videoPath . '/' . $imageName;
                  $exec = VIDEO_FFMPEG_PATH . " -i $videoFilePath -f image2 -vframes 1 $imagePath -ss $frame";
                  //$exec = VIDEO_FFMPEG_PATH . "ffmpeg -i $videoFilePath -r " . VIDEO_FRAMES_PER_SEC ." -f image2 $filename_%02d.png";
                  //exec($exec);
                  $return[$num] = $imageName;
                  ++$num;
                  }
                  }
                  }
                 * 
                 */

                $encodedArr = json_encode($return);
                file_put_contents($jsonPath, $encodedArr);
                return json_decode($encodedArr);
            } else {
                return false;
            }
        }
    }

    public static function getVideoDuration($videoFilePath) {

        if (file_exists($videoFilePath)) {
            $cmd = VIDEO_FFMPEG_PATH . " -i $videoFilePath 2>&1 | grep Duration |  awk '{print $2}' | tr -d ,";
            $result = exec($cmd);
            return explode(":", $result);
        } else {
            return false;
        }
    }

    public static function getIndicatorColor($videoDuration) {

        $maxDuration = (float) Yii::app()->params['video']['duration'];
        $thresholdMin = (float) Yii::app()->params['videoAdmin']['indicatorThreshold']['min'];
        $thresholdMax = (float) Yii::app()->params['videoAdmin']['indicatorThreshold']['max'];
        $videoDuration = (float) $videoDuration;


        // if under the max
        if ($videoDuration < $maxDuration) {
            $str = 'red';
        }
        // if over
        elseif ($videoDuration > $maxDuration) {

            // if under $thresholdMin = green
            $diff = $videoDuration - $maxDuration;
            $diff = (float) $diff;

            if ($diff < $thresholdMin) {
                $str = 'green';
            }
            // else, if over $thresholdMin and under $thresholdMax = yellow 
            elseif ($diff >= $thresholdMin && $diff < $thresholdMax) {
                $str = 'yellow';
            }
            // else greater than $thresholdMax = red
            else {
                $str = 'red';
            }
        }
        // if equal (rare)
        else {
            $str = 'green';
        }

        return $str;
    }

    // get values for video source dropdown
    public static function getSources() {
        $result = eVideo::model()->findAll(array(
            'select' => '`t`.`source`',
            'group' => '`t`.`source`',
            'distinct' => true,
                ));

        $sources = Utility::resultToKeyValue($result, 'source', 'source');
        
        foreach($sources as $key=>$val) {
            // fuck you apple
            if($val[0] != 'i') {
                $sources[$key] = ucfirst($val);
            }
        }
        
        $sources = CMap::mergeArray(array('all' => 'All'), $sources);
        return $sources;
    }

    // gets values for video status dropdown
    public static function getStatuses() {
        if(VIDEO_FILTERS_EXTENDED)
        {
            $extendedLabels = unserialize(VIDEO_FILTERS_EXTENDED_LABELS);
            
            foreach($extendedLabels as &$value)
            {
                if(Yii::app()->user->isSuperAdmin() || Yii::app()->user->isSiteAdmin() || Yii::app()->user->hasPermission(key($value)))
                {
                    $extendedAdmin = CMap::mergeArray($extendedAdmin, $value);
                }
            }

            if(Yii::app()->user->isSuperAdmin())
            {
                $extendedAdmin = CMap::mergeArray($extendedAdmin, unserialize(VIDEO_FILTERS_EXTENDED_SUPADMIN_LABELS));
            }
            
            return $extendedAdmin;
        }
        else
        {
            $prodAdmin = array('new' => 'New',
            'accepted' => 'Accepted');

            if (Yii::app()->user->isSuperAdmin()) {
                $superAdmin = array('denied' => 'Deleted',
                    'all' => 'All');
            }
            
            return CMap::mergeArray($prodAdmin, $superAdmin);
        }
    }
    
    public static function getDefaultStatus()
    {
        if(VIDEO_FILTERS_EXTENDED)
        {
            $defaultStatus = Utility::getDefaultStatus(VIDEO_FILTERS_EXTENDED_LABELS);
        }
        else
        {
            $defaultStatus = 'new';
        }
            
        return $defaultStatus;
    }

    public static function getVideoFileExtention($processed = 0) {

        if ($processed == 1) {
            return VIDEO_POST_FILE_EXT;
        } else {
            return VIDEO_PRE_FILE_EXT;
        }
    }

    public static function getPerPageOptions() {
        return array('12' => '12',
            '24' => '24',
            '36' => '36',
            '48' => '48'
        );
    }

    public static function getID3Info($fileInput) {
        $id3 = new getID3;
        $fileInfo = $id3->analyze($fileInput);
        return $fileInfo;
    }

}

?>
